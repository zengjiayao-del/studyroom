# 自习室预约管理系统 - 系统设计文档

## 一、总体设计

### 1. 系统概述

自习室预约管理系统是一个基于Web的智能化座位管理平台，旨在解决传统自习室座位管理中的资源分配不均、使用效率低下、管理成本高等问题。系统通过数字化手段实现座位的在线预约、实时监控、数据分析和智能管理，为用户提供便捷的预约服务，为管理员提供科学的管理工具。

**核心功能模块：**
- 用户管理：学生注册、登录、个人信息管理
- 座位预约：自习室选择、座位预约、签到管理
- 违规管理：警告记录、黑名单机制、撤销申请
- 评价投诉：用户评价、投诉处理、反馈管理
- 数据分析：使用率统计、趋势分析、决策支持
- 系统管理：签到码生成、后台管理、权限控制

**技术特点：**
- 前后端分离架构，支持多端访问
- 响应式设计，适配各种设备
- 实时数据更新，提供准确信息
- 智能数据分析，辅助管理决策
- 安全权限控制，保障系统稳定

### 2. 体系结构设计

#### 2.1 架构风格

**B/S架构（Browser/Server）**
```
┌─────────────────────────────────────────────────────────────┐
│                    客户端层 (Browser)                    │
├─────────────────────────────────────────────────────────────┤
│  Web浏览器  │  移动端浏览器  │  管理员控制台        │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼ HTTP/HTTPS
┌─────────────────────────────────────────────────────────────┐
│                    服务器端 (Server)                     │
├─────────────────────────────────────────────────────────────┤
│  Web服务器  │  应用服务器  │  数据库服务器          │
└─────────────────────────────────────────────────────────────┘
```

**MVC架构模式（Model-View-Controller）**
```
┌─────────────────────────────────────────────────────────────┐
│                    MVC分层架构                           │
├─────────────────────────────────────────────────────────────┤
│  Model层     │  View层       │  Controller层        │
│  (数据模型)   │  (视图模板)    │  (业务逻辑)           │
│  - Students   │  - HTML模板    │  - views.py          │
│  - Rooms      │  - 前端页面    │  - API接口           │
│  - Bookings   │  - 管理界面    │  - 业务处理           │
└─────────────────────────────────────────────────────────────┘
```

#### 2.2 组件架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    前端展示层                           │
├─────────────────────────────────────────────────────────────┤
│  用户界面      │  管理界面      │  数据可视化界面        │
│  - 预约页面   │  - 后台管理    │  - 图表展示          │
│  - 个人中心   │  - 用户管理    │  - 报表导出          │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼ API调用
┌─────────────────────────────────────────────────────────────┐
│                   业务逻辑层                             │
├─────────────────────────────────────────────────────────────┤
│  用户模块      │  预约模块      │  分析模块            │
│  - 登录认证   │  - 座位管理    │  - 统计计算          │
│  - 权限控制   │  - 签到处理    │  - 趋势分析          │
│  - 信息管理   │  - 违规处理    │  - 决策建议          │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼ ORM映射
┌─────────────────────────────────────────────────────────────┐
│                   数据访问层                             │
├─────────────────────────────────────────────────────────────┤
│  Django ORM   │  数据库连接    │  缓存管理            │
│  - 模型映射   │  - 连接池      │  - Session管理        │
│  - 查询优化   │  - 事务处理    │  - 静态文件缓存        │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼ 数据存储
┌─────────────────────────────────────────────────────────────┐
│                   数据存储层                             │
├─────────────────────────────────────────────────────────────┤
│  MySQL数据库  │  文件存储      │  日志存储            │
│  - 用户数据   │  - 头像文件    │  - 访问日志          │
│  - 预约记录   │  - 音频文件    │  - 错误日志          │
│  - 系统配置   │  - 导出文件    │  - 操作日志          │
└─────────────────────────────────────────────────────────────┘
```

### 3. 模块划分（子系统设计）

#### 3.1 用户管理子系统
```
用户管理子系统
├── 用户认证模块
│   ├── 用户注册
│   ├── 用户登录
│   ├── 密码重置
│   └── 权限验证
├── 个人信息管理模块
│   ├── 基本信息维护
│   ├── 头像上传
│   ├── 偏好设置
│   └── 密码修改
└── 权限控制模块
    ├── 学生权限
    ├── 管理员权限
    └── 超级管理员权限
```

#### 3.2 预约管理子系统
```
预约管理子系统
├── 自习室管理模块
│   ├── 自习室信息维护
│   ├── 座位数量配置
│   └── 状态管理
├── 座位预约模块
│   ├── 座位查询
│   ├── 预约操作
│   ├── 预约冲突检测
│   └── 预约记录管理
├── 签到管理模块
│   ├── 签到码生成
│   ├── 签到验证
│   └── 签到记录
└── 预约状态管理
    ├── 预约状态跟踪
    ├── 自动取消机制
    └── 历史记录查询
```

#### 3.3 违规管理子系统
```
违规管理子系统
├── 警告记录模块
│   ├── 违规行为记录
│   ├── 警告等级设置
│   └── 警告历史查询
├── 黑名单管理模块
│   ├── 黑名单添加
│   ├── 黑名单查询
│   ├── 黑名单撤销申请
│   └── 撤销审核流程
└── 积分管理模块
    ├── 积分计算规则
    ├── 积分扣除机制
    └── 积分恢复策略
```

#### 3.4 评价投诉子系统
```
评价投诉子系统
├── 用户评价模块
│   ├── 评价提交
│   ├── 评价展示
│   ├── 评价统计
│   └── 评价审核
├── 投诉管理模块
│   ├── 投诉提交
│   ├── 投诉分类
│   ├── 投诉处理流程
│   └── 投诉反馈
└── 反馈管理模块
    ├── 反馈回复
    ├── 反馈跟踪
    └── 满意度调查
```

#### 3.5 数据分析子系统
```
数据分析子系统
├── 实时监控模块
│   ├── 当前使用率
│   ├── 实时预约状态
│   └── 系统健康状态
├── 统计分析模块
│   ├── 使用率统计
│   ├── 预约趋势分析
│   ├── 用户行为分析
│   └── 违规趋势分析
├── 报表生成模块
│   ├── 日报表
│   ├── 周报表
│   ├── 月报表
│   └── 自定义报表
└── 决策支持模块
    ├── 高峰时段预测
    ├── 资源配置建议
    ├── 风险预警
    └── 优化建议
```

### 4. 数据设计（概念数据模型）

#### 4.1 核心实体关系图
```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  Students  │    │   Rooms     │    │ Bookings   │
│  (学生)    │    │  (自习室)   │    │  (预约)    │
├─────────────┤    ├─────────────┤    ├─────────────┤
│ id (PK)    │    │ id (PK)     │    │ id (PK)     │
│ name        │    │ name         │    │ students_id │
│ password    │    │ number       │    │ room_id     │
│ phone       │    │ photo        │    │ number      │
│ email       │    │ is_active    │    │ period      │
│ photo       │    └─────────────┘    │ time        │
│ is_active   │           │           │ is_active   │
│ ...         │           │           └─────────────┘
└─────────────┘           │                    │
         │                │                    │
         │                │                    │
         ▼                ▼                    ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ Integrals  │    │ Blacklist   │    │SignCode    │
│ (警告记录)  │    │ (黑名单)    │    │ (签到码)    │
├─────────────┤    ├─────────────┤    ├─────────────┤
│ id (PK)     │    │ id (PK)     │    │ id (PK)     │
│ student_id  │    │ student_id  │    │ text        │
│ title       │    │ reason      │    │ time        │
│ text        │    │ start_time  │    │ is_active   │
│ time        │    │ end_time    │    └─────────────┘
│ is_active   │    │ is_active   │
└─────────────┘    └─────────────┘
         │                │
         │                │
         ▼                ▼
┌─────────────┐    ┌─────────────┐
│UserEvaluation│    │UserComplaint│
│ (用户评价)  │    │ (用户投诉)  │
├─────────────┤    ├─────────────┤
│ id (PK)     │    │ id (PK)     │
│ student_id  │    │ student_id  │
│ room_id     │    │ type        │
│ rating      │    │ title       │
│ comment     │    │ content     │
│ time        │    │ time        │
│ is_active   │    │ status      │
└─────────────┘    │ is_active   │
                  └─────────────┘
```

#### 4.2 数据模型设计原则

**规范化设计：**
- 第一范式：所有字段都是原子性的，不可再分
- 第二范式：非主键字段完全依赖于主键
- 第三范式：消除传递依赖，确保数据一致性

**关系设计：**
- 一对一：用户扩展信息
- 一对多：自习室-座位、用户-预约
- 多对多：用户-角色（通过中间表）

**约束设计：**
- 主键约束：确保记录唯一性
- 外键约束：保证引用完整性
- 检查约束：验证数据有效性
- 唯一约束：防止重复数据

### 5. 接口设计（模块间接口）

#### 5.1 前后端接口规范

**RESTful API设计**
```
API基础路径: /api/v1/
认证方式: Session/Cookie
数据格式: JSON
字符编码: UTF-8
```

**用户管理接口**
```
POST   /api/v1/auth/login          # 用户登录
POST   /api/v1/auth/logout         # 用户登出
POST   /api/v1/auth/register       # 用户注册
GET    /api/v1/user/profile       # 获取用户信息
PUT    /api/v1/user/profile       # 更新用户信息
POST   /api/v1/user/avatar        # 上传头像
```

**预约管理接口**
```
GET    /api/v1/rooms             # 获取自习室列表
GET    /api/v1/rooms/{id}/seats  # 获取座位状态
POST   /api/v1/bookings          # 创建预约
GET    /api/v1/bookings          # 获取预约列表
PUT    /api/v1/bookings/{id}     # 修改预约
DELETE /api/v1/bookings/{id}     # 取消预约
POST   /api/v1/signin            # 签到验证
```

**数据分析接口**
```
GET    /api/v1/analytics/usage    # 使用率统计
GET    /api/v1/analytics/trends   # 趋势分析
GET    /api/v1/analytics/reports  # 报表数据
POST   /api/v1/analytics/export   # 导出报表
```

#### 5.2 模块间通信接口

**事件驱动接口**
```
用户注册事件 → 邮件服务模块
预约成功事件 → 消息通知模块
违规检测事件 → 黑名单管理模块
系统异常事件 → 日志监控模块
```

**服务调用接口**
```
用户服务 → 预约服务: 验证用户预约权限
预约服务 → 分析服务: 提供预约统计数据
评价服务 → 通知服务: 发送评价提醒
管理服务 → 权限服务: 验证管理员操作权限
```

## 二、详细设计

### 6. 设计类模型（类图细化）

#### 6.1 用户管理类图
```
┌─────────────────────────────────────────────────────────────┐
│                    用户管理类图                           │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐  │
│  │   User      │    │  Student    │    │  AdminUser  │  │
│  │  (用户基类) │    │  (学生)     │    │  (管理员)   │  │
│  ├─────────────┤    ├─────────────┤    ├─────────────┤  │
│  │ +id: int    │    │ +id: int    │    │ +id: int    │  │
│  │ +username:  │    │ +name: str  │    │ +username:  │  │
│  │   str       │    │ +email: str │    │   str       │  │
│  │ +email: str │    │ +phone: str │    │ +role: str  │  │
│  │ +password:  │    │ +photo: str │    │ +level: int │  │
│  │   str       │    │ +preferences│    │             │  │
│  │ +isActive:  │    │   : dict    │    │ +login()    │  │
│  │   bool      │    │ +login()    │    │ +logout()   │  │
│  │ +login()    │    │ +logout()   │    │ +manage()   │  │
│  │ +logout()   │    │ +update()   │    │ +audit()    │  │
│  │ +update()   │    │ +book()     │    └─────────────┘  │
│  └─────────────┘    │ +cancel()   │                   │
│         │           └─────────────┘                   │
│         │                   │                       │
│         ▼                   ▼                       │
│  ┌─────────────┐    ┌─────────────┐               │
│  │AuthService │    │UserService │               │
│  │(认证服务)  │    │(用户服务)  │               │
│  ├─────────────┤    ├─────────────┤               │
│  │+authenticate│    │+create()    │               │
│  │+authorize  │    │+findById()   │               │
│  │+validate   │    │+update()    │               │
│  │+logSession │    │+delete()    │               │
│  └─────────────┘    └─────────────┘               │
└─────────────────────────────────────────────────────────────┘
```

#### 6.2 预约管理类图
```
┌─────────────────────────────────────────────────────────────┐
│                    预约管理类图                           │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐  │
│  │   Room      │    │  Seat       │    │  Booking    │  │
│  │  (自习室)   │    │  (座位)     │    │  (预约)     │  │
│  ├─────────────┤    ├─────────────┤    ├─────────────┤  │
│  │ +id: int    │    │ +id: int    │    │ +id: int    │  │
│  │ +name: str  │    │ +number: int│    │ +student:   │  │
│  │ +capacity:  │    │ +room: Room │    │   Student   │  │
│  │   int       │    │ +status:    │    │ +room: Room │  │
│  │ +location:  │    │   enum      │    │ +seatNum:   │  │
│  │   str       │    │ +isAvailable│    │   int       │  │
│  │ +facilities:│    │   : bool     │    │ +period:    │  │
│  │   list      │    │ +reserve()  │    │   enum      │  │
│  │ +isActive:  │    │ +release()  │    │ +status:    │  │
│  │   bool      │    │ +getStatus() │    │   enum      │  │
│  │ +getSeats() │    │ └─────────────┘    │ +time: datetime│  │
│  │ +getUsage() │    │                   │ +cancel()   │  │
│  │ +update()   │    │                   │ +confirm()  │  │
│  └─────────────┘    │                   │ +checkIn()  │  │
│         │           │                   │ +isExpired()│  │
│         ▼           │                   │ └─────────────┘  │
│  ┌─────────────┐    │                   │                   │
│  │RoomService │    │                   │                   │
│  │(自习室服务)│    │                   │                   │
│  ├─────────────┤    │                   │                   │
│  │+create()   │    │                   │                   │
│  │+findById()  │    │                   │                   │
│  │+update()   │    │                   │                   │
│  │+delete()   │    │                   │                   │
│  │+getUsage() │    │                   │                   │
│  │+getSeats() │    │                   │                   │
│  └─────────────┘    │                   │                   │
└─────────────────────────────────────────────────────────────┘
```

### 7. 行为设计（顺序图、状态图等）

#### 7.1 用户预约顺序图
```
用户预约座位顺序图
┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│    用户     │  │   预约系统   │  │   座位服务   │  │   数据库     │
└─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘
       │              │              │              │
       │1. 选择自习室   │              │              │
       ├─────────────→│              │              │
       │              │2. 获取自习室信息│              │
       │              ├─────────────→│              │
       │              │              │3. 查询座位状态│
       │              │              ├─────────────→│
       │              │              │              │4. 返回座位数据
       │              │              │←─────────────┤
       │              │5. 显示可用座位  │              │
       │              │←─────────────┤              │
       │6. 选择座位和时间│              │              │
       ├─────────────→│              │              │
       │              │7. 验证预约条件│              │
       │              ├─────────────→│              │
       │              │              │8. 检查时间冲突│
       │              │              ├─────────────→│
       │              │              │              │9. 返回验证结果
       │              │              │←─────────────┤
       │              │10.创建预约记录 │              │
       │              ├─────────────→│              │
       │              │              │11.保存到数据库 │
       │              │              ├─────────────→│
       │              │              │              │12.确认保存成功
       │              │              │←─────────────┤
       │              │13.返回预约结果│              │
       │              │←─────────────┤              │
       │14.显示预约成功  │              │              │
       │←─────────────┤              │              │
       │              │              │              │
```

#### 7.2 预约状态图
```
预约状态转换图
┌─────────────┐
│  已预约     │
│ (Booked)   │
└─────────────┘
       │
       │ 签到
       ▼
┌─────────────┐    取消    ┌─────────────┐
│  已签到     │◄──────────│  已取消     │
│ (Checked)   │           │ (Cancelled)  │
└─────────────┘           └─────────────┘
       │
       │ 过期/未签到
       ▼
┌─────────────┐
│  未签到     │
│(No-Show)   │
└─────────────┘
```

#### 7.3 用户登录状态图
```
用户登录状态图
┌─────────────┐
│  未登录     │
│ (Logged Out)│
└─────────────┘
       │
       │ 输入凭据
       ▼
┌─────────────┐    验证失败    ┌─────────────┐
│  验证中     │◄───────────│  登录失败   │
│(Validating) │             │ (Failed)    │
└─────────────┘             └─────────────┘
       │
       │ 验证成功
       ▼
┌─────────────┐
│  已登录     │
│ (Logged In) │
└─────────────┘
       │
       │ 登出/超时
       ▼
┌─────────────┐
│  未登录     │
│ (Logged Out)│
└─────────────┘
```

### 8. 详细接口设计（API、方法说明）

#### 8.1 用户认证API

**用户登录接口**
```
POST /api/v1/auth/login
Content-Type: application/json

Request:
{
    "username": "string",    // 用户名
    "password": "string"     // 密码
}

Response (200):
{
    "success": true,
    "user": {
        "id": 1,
        "username": "student01",
        "email": "student@example.com",
        "photo": "/media/photos/student01.jpg"
    },
    "token": "session_token",
    "permissions": ["student"]
}

Response (401):
{
    "success": false,
    "message": "用户名或密码错误"
}
```

**用户注册接口**
```
POST /api/v1/auth/register
Content-Type: application/json

Request:
{
    "username": "string",    // 用户名 (必填，唯一)
    "password": "string",    // 密码 (必填，6-20位)
    "email": "string",      // 邮箱 (必填，唯一)
    "phone": "string",      // 手机号 (必填，11位)
    "photo": "file"         // 头像文件 (可选)
}

Response (201):
{
    "success": true,
    "message": "注册成功",
    "user_id": 123
}

Response (400):
{
    "success": false,
    "message": "用户名已存在"
}
```

#### 8.2 预约管理API

**获取自习室列表**
```
GET /api/v1/rooms
Query Parameters:
    - page: int (页码，默认1)
    - size: int (每页数量，默认10)
    - available: bool (是否只显示可用自习室)

Response (200):
{
    "success": true,
    "data": {
        "rooms": [
            {
                "id": 1,
                "name": "一楼1号自习室",
                "capacity": 40,
                "available": 38,
                "location": "一楼东侧",
                "facilities": ["WiFi", "空调", "电源"],
                "photo": "/media/rooms/room1.jpg"
            }
        ],
        "pagination": {
            "page": 1,
            "size": 10,
            "total": 3,
            "pages": 1
        }
    }
}
```

**创建预约**
```
POST /api/v1/bookings
Content-Type: application/json

Request:
{
    "room_id": 1,              // 自习室ID (必填)
    "seat_number": 15,          // 座位号 (必填)
    "period": 2,               // 时段 (1:上午,2:下午,3:晚自习)
    "date": "2025-11-21",     // 预约日期 (必填)
    "duration": 2              // 预约时长 (小时，可选)
}

Response (201):
{
    "success": true,
    "message": "预约成功",
    "booking": {
        "id": 1001,
        "room_name": "一楼1号自习室",
        "seat_number": 15,
        "period": "下午",
        "date": "2025-11-21",
        "status": "booked",
        "qr_code": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAA..."
    }
}

Response (409):
{
    "success": false,
    "message": "该座位在此时段已被预约"
}
```

#### 8.3 数据分析API

**使用率统计接口**
```
GET /api/v1/analytics/usage
Query Parameters:
    - date: string (日期范围: today, week, month)
    - room_id: int (自习室ID，可选)

Response (200):
{
    "success": true,
    "data": {
        "analysis_info": {
            "date": "今日",
            "total_rooms": 3,
            "total_seats": 134
        },
        "usage_by_time": {
            "labels": ["08:00-10:00", "10:00-12:00", ...],
            "values": [15.2, 45.8, 32.1, ...]
        },
        "room_usage": [
            {
                "room_id": 1,
                "room_name": "一楼1号自习室",
                "total_seats": 40,
                "used_seats": 6,
                "usage_rate": 15.0,
                "peak_hour": "14:00-16:00"
            }
        ],
        "statistics": {
            "total_bookings": 25,
            "current_usage": 18.7,
            "peak_time": "14:00-16:00 (平均使用率: 65.2%)",
            "satisfaction_rate": 85.5
        }
    }
}
```

### 9. 数据库物理设计（表字段）

#### 9.1 学生表 (Students)
```sql
CREATE TABLE Students (
    id INT AUTO_INCREMENT PRIMARY KEY COMMENT '学生ID',
    name VARCHAR(22) NOT NULL COMMENT '姓名',
    password VARCHAR(128) NOT NULL COMMENT '密码(加密存储)',
    phone VARCHAR(11) NOT NULL UNIQUE COMMENT '手机号',
    email VARCHAR(22) NOT NULL UNIQUE COMMENT '邮箱',
    photo VARCHAR(255) DEFAULT '' COMMENT '头像路径',
    bio TEXT DEFAULT '' COMMENT '个人简介',
    study_preference ENUM('quiet', 'group', 'flexible', 'other') 
                     DEFAULT 'quiet' COMMENT '学习偏好',
    preferred_room_id INT NULL COMMENT '常用自习室ID',
    last_login DATETIME NULL COMMENT '上次登录时间',
    is_active TINYINT(1) DEFAULT 1 COMMENT '活跃状态',
    time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    
    INDEX idx_name (name),
    INDEX idx_email (email),
    INDEX idx_phone (phone),
    INDEX idx_active (is_active),
    
    FOREIGN KEY (preferred_room_id) REFERENCES Rooms(id) 
               ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='学生信息表';
```

#### 9.2 自习室表 (Rooms)
```sql
CREATE TABLE Rooms (
    id INT AUTO_INCREMENT PRIMARY KEY COMMENT '自习室ID',
    name VARCHAR(22) NOT NULL COMMENT '自习室名称',
    number INT NOT NULL DEFAULT 0 COMMENT '座位数量',
    photo VARCHAR(255) DEFAULT '' COMMENT '自习室照片',
    location VARCHAR(100) DEFAULT '' COMMENT '位置描述',
    facilities JSON DEFAULT NULL COMMENT '设施配置',
    description TEXT DEFAULT '' COMMENT '自习室描述',
    is_active TINYINT(1) DEFAULT 1 COMMENT '活跃状态',
    time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    
    INDEX idx_name (name),
    INDEX idx_active (is_active),
    INDEX idx_location (location)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='自习室信息表';
```

#### 9.3 预约表 (Bookings)
```sql
CREATE TABLE Bookings (
    id INT AUTO_INCREMENT PRIMARY KEY COMMENT '预约ID',
    students_id INT NOT NULL COMMENT '学生ID',
    room_id INT NOT NULL COMMENT '自习室ID',
    number INT NOT NULL COMMENT '座位号',
    period ENUM('1', '2', '3') NOT NULL DEFAULT '1' 
            COMMENT '时段(1:上午,2:下午,3:晚自习)',
    time DATETIME NOT NULL COMMENT '预约时间',
    booking_date DATE NOT NULL COMMENT '预约日期',
    duration INT DEFAULT 2 COMMENT '预约时长(小时)',
    status ENUM('1', '2', '3', '4') NOT NULL DEFAULT '1' 
            COMMENT '状态(1:预约,2:已签到,3:未签到,4:已取消)',
    check_in_time DATETIME NULL COMMENT '签到时间',
    cancel_time DATETIME NULL COMMENT '取消时间',
    cancel_reason VARCHAR(255) DEFAULT '' COMMENT '取消原因',
    qr_code VARCHAR(500) DEFAULT '' COMMENT '签到二维码',
    is_active TINYINT(1) DEFAULT 1 COMMENT '活跃状态',
    
    INDEX idx_student (students_id),
    INDEX idx_room (room_id),
    INDEX idx_date (booking_date),
    INDEX idx_status (status),
    INDEX idx_seat_room_date (room_id, number, booking_date),
    
    FOREIGN KEY (students_id) REFERENCES Students(id) 
               ON DELETE CASCADE,
    FOREIGN KEY (room_id) REFERENCES Rooms(id) 
               ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='预约记录表';
```

#### 9.4 黑名单表 (Blacklist)
```sql
CREATE TABLE Blacklist (
    id INT AUTO_INCREMENT PRIMARY KEY COMMENT '黑名单ID',
    student_id INT NOT NULL COMMENT '学生ID',
    reason TEXT NOT NULL COMMENT '拉黑原因',
    start_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '开始时间',
    end_time DATETIME NULL COMMENT '结束时间',
    duration_days INT NULL COMMENT '持续天数',
    severity ENUM('low', 'medium', 'high') DEFAULT 'medium' 
              COMMENT '严重程度',
    operator_id INT NULL COMMENT '操作管理员ID',
    is_active TINYINT(1) DEFAULT 1 COMMENT '活跃状态',
    
    INDEX idx_student (student_id),
    INDEX idx_active (is_active),
    INDEX idx_start_time (start_time),
    
    FOREIGN KEY (student_id) REFERENCES Students(id) 
               ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='黑名单管理表';
```

#### 9.5 用户评价表 (UserEvaluation)
```sql
CREATE TABLE UserEvaluation (
    id INT AUTO_INCREMENT PRIMARY KEY COMMENT '评价ID',
    student_id INT NOT NULL COMMENT '学生ID',
    room_id INT NOT NULL COMMENT '自习室ID',
    rating ENUM('1', '2', '3', '4', '5') NOT NULL DEFAULT '5' 
            COMMENT '评分(1-5星)',
    comment TEXT DEFAULT '' COMMENT '评价内容',
    tags JSON DEFAULT NULL COMMENT '评价标签',
    is_approved TINYINT(1) DEFAULT 0 COMMENT '审核状态',
    admin_reply TEXT DEFAULT '' COMMENT '管理员回复',
    time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '评价时间',
    is_active TINYINT(1) DEFAULT 1 COMMENT '活跃状态',
    
    INDEX idx_student (student_id),
    INDEX idx_room (room_id),
    INDEX idx_rating (rating),
    INDEX idx_approved (is_approved),
    INDEX idx_time (time),
    
    FOREIGN KEY (student_id) REFERENCES Students(id) 
               ON DELETE CASCADE,
    FOREIGN KEY (room_id) REFERENCES Rooms(id) 
               ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户评价表';
```

## 三、非功能设计

### 10. 性能、安全、异常处理等

#### 10.1 性能设计

**数据库优化**
```sql
-- 索引策略
CREATE INDEX idx_booking_composite ON Bookings(room_id, booking_date, status);
CREATE INDEX idx_student_active ON Students(is_active, last_login);
CREATE INDEX idx_room_usage ON Rooms(id, is_active, number);

-- 分区策略 (按月分区预约表)
ALTER TABLE Bookings PARTITION BY RANGE (YEAR(booking_date)*100 + MONTH(booking_date)) (
    PARTITION p202511 VALUES LESS THAN (202512),
    PARTITION p202512 VALUES LESS THAN (202601),
    PARTITION p_future VALUES LESS THAN MAXVALUE
);

-- 查询优化
EXPLAIN SELECT * FROM Bookings 
WHERE room_id = 1 AND booking_date = '2025-11-21' AND status = '1';
```

**缓存策略**
```python
# Redis缓存配置
CACHES = {
    'default': {
        'BACKEND': 'django_redis.cache.RedisCache',
        'LOCATION': 'redis://127.0.0.1:6379/1',
        'OPTIONS': {
            'CLIENT_CLASS': 'django_redis.client.DefaultClient',
        },
        'KEY_PREFIX': 'studyroom_',
        'TIMEOUT': 300,  # 5分钟默认过期
    }
}

# 缓存使用示例
@cache_page(60)  # 缓存1小时
def room_list(request):
    pass

@cache.cached(timeout=300, key='room_usage_{room_id}')
def get_room_usage(room_id):
    pass
```

**性能监控**
```python
# 性能监控中间件
class PerformanceMiddleware:
    def __init__(self, get_response):
        self.get_response = get_response
    
    def __call__(self, request):
        start_time = time.time()
        response = self.get_response(request)
        end_time = time.time()
        
        # 记录慢查询
        if end_time - start_time > 2.0:
            logger.warning(f"Slow request: {request.path} took {end_time - start_time:.2f}s")
        
        response['X-Response-Time'] = f"{end_time - start_time:.3f}"
        return response
```

#### 10.2 安全设计

**认证与授权**
```python
# JWT Token配置
import jwt
from datetime import datetime, timedelta

JWT_SECRET_KEY = 'your-secret-key'
JWT_ALGORITHM = 'HS256'
JWT_EXPIRATION_DELTA = timedelta(hours=24)

def generate_token(user_id):
    payload = {
        'user_id': user_id,
        'exp': datetime.utcnow() + JWT_EXPIRATION_DELTA,
        'iat': datetime.utcnow()
    }
    return jwt.encode(payload, JWT_SECRET_KEY, algorithm=JWT_ALGORITHM)

# 权限装饰器
def require_permission(permission):
    def decorator(view_func):
        def wrapper(request, *args, **kwargs):
            if not request.user.has_perm(permission):
                return JsonResponse({'error': 'Permission denied'}, status=403)
            return view_func(request, *args, **kwargs)
        return wrapper
    return decorator
```

**数据验证与清理**
```python
# 输入验证
from django.core.validators import RegexValidator
from django.core.exceptions import ValidationError

class PhoneValidator(RegexValidator):
    regex = r'^1[3-9]\d{9}$'
    message = '请输入有效的手机号码'

# SQL注入防护
from django.db.models import Q

def safe_user_search(query):
    return Students.objects.filter(
        Q(name__icontains=query) |
        Q(email__icontains=query) |
        Q(phone__icontains=query)
    )

# XSS防护
from django.utils.html import escape
def safe_html_content(content):
    return escape(content)
```

**安全配置**
```python
# 安全设置
SECURE_BROWSER_XSS_FILTER = True
SECURE_CONTENT_TYPE_NOSNIFF = True
SECURE_HSTS_SECONDS = 31536000
SECURE_HSTS_INCLUDE_SUBDOMAINS = True
SECURE_HSTS_PRELOAD = True

# CSRF保护
CSRF_COOKIE_SECURE = True
CSRF_COOKIE_HTTPONLY = True
CSRF_TRUSTED_ORIGINS = ['https://yourdomain.com']

# Session安全
SESSION_COOKIE_SECURE = True
SESSION_COOKIE_HTTPONLY = True
SESSION_COOKIE_AGE = 3600  # 1小时
SESSION_SAVE_EVERY_REQUEST = True
```

#### 10.3 异常处理设计

**全局异常处理**
```python
# 自定义异常类
class StudyRoomException(Exception):
    """自习室系统基础异常"""
    def __init__(self, message, error_code=None):
        self.message = message
        self.error_code = error_code
        super().__init__(message)

class BookingConflictException(StudyRoomException):
    """预约冲突异常"""
    pass

class PermissionDeniedException(StudyRoomException):
    """权限拒绝异常"""
    pass

# 异常处理中间件
class ExceptionHandlerMiddleware:
    def __init__(self, get_response):
        self.get_response = get_response
    
    def __call__(self, request):
        try:
            response = self.get_response(request)
            return response
        except StudyRoomException as e:
            return JsonResponse({
                'success': False,
                'error_code': e.error_code,
                'message': e.message
            }, status=400)
        except Exception as e:
            logger.error(f"Unhandled exception: {str(e)}", exc_info=True)
            return JsonResponse({
                'success': False,
                'message': '系统内部错误'
            }, status=500)
```

**业务异常处理**
```python
# 预约业务异常处理
def create_booking(request):
    try:
        # 验证用户权限
        if not request.user.is_authenticated:
            raise PermissionDeniedException("用户未登录", "AUTH_001")
        
        # 检查预约冲突
        if has_booking_conflict(request.data):
            raise BookingConflictException("座位已被预约", "BOOKING_001")
        
        # 创建预约
        booking = Booking.objects.create(**request.data)
        return JsonResponse({'success': True, 'booking_id': booking.id})
        
    except ValidationError as e:
        return JsonResponse({'success': False, 'message': str(e)}, status=400)
    except StudyRoomException as e:
        return JsonResponse({'success': False, 'message': e.message}, status=400)
```

**日志记录**
```python
# 日志配置
LOGGING = {
    'version': 1,
    'disable_existing_loggers': False,
    'formatters': {
        'verbose': {
            'format': '{levelname} {asctime} {module} {process:d} {thread:d} {message}',
            'style': '{',
        },
        'simple': {
            'format': '{levelname} {message}',
            'style': '{',
        },
    },
    'handlers': {
        'file': {
            'level': 'INFO',
            'class': 'logging.FileHandler',
            'filename': 'logs/studyroom.log',
            'formatter': 'verbose',
        },
        'error_file': {
            'level': 'ERROR',
            'class': 'logging.FileHandler',
            'filename': 'logs/studyroom_error.log',
            'formatter': 'verbose',
        },
    },
    'loggers': {
        'django': {
            'handlers': ['file', 'error_file'],
            'level': 'INFO',
            'propagate': True,
        },
        'studyroom': {
            'handlers': ['file', 'error_file'],
            'level': 'DEBUG',
            'propagate': False,
        },
    },
}

# 业务日志记录
import logging
logger = logging.getLogger('studyroom')

def log_user_action(user, action, details=None):
    logger.info(f"User {user.id}({user.name}) performed {action}. Details: {details}")

def log_system_event(event, level='info'):
    getattr(logger, level)(f"System event: {event}")
```

#### 10.4 可扩展性设计

**微服务架构准备**
```python
# 服务接口抽象
class BookingServiceInterface:
    def create_booking(self, data): pass
    def cancel_booking(self, booking_id): pass
    def get_booking_status(self, booking_id): pass

# 当前实现
class DjangoBookingService(BookingServiceInterface):
    def create_booking(self, data):
        return Booking.objects.create(**data)

# 未来微服务实现
class MicroserviceBookingService(BookingServiceInterface):
    def create_booking(self, data):
        return requests.post('http://booking-service/api/bookings', json=data).json()
```

**配置管理**
```python
# 环境配置
class Config:
    DEBUG = os.environ.get('DEBUG', 'False') == 'True'
    DATABASE_URL = os.environ.get('DATABASE_URL')
    REDIS_URL = os.environ.get('REDIS_URL')
    SECRET_KEY = os.environ.get('SECRET_KEY')

class DevelopmentConfig(Config):
    DEBUG = True
    DATABASE_URL = 'mysql://user:pass@localhost/studyroom_dev'

class ProductionConfig(Config):
    DEBUG = False
    DATABASE_URL = os.environ.get('PROD_DATABASE_URL')

# 配置切换
config = {
    'development': DevelopmentConfig,
    'production': ProductionConfig
}[os.environ.get('ENVIRONMENT', 'development')]
```

这个系统设计文档全面涵盖了自习室预约管理系统的架构设计、详细实现和非功能性要求，为系统的开发、部署和维护提供了完整的技术指导。